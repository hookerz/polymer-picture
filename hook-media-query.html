<script type="module">
  export default class HookMediaQuery extends Polymer.Element {
    static get is() {
      return 'hook-media-query';
    }
    static get properties() {
      return {

        /**
         * The Boolean return value of the media query.
         */
        queryMatches: {
          type: Boolean,
          value: false,
          readOnly: true,
          notify: true
        },
        /**
         * The CSS media query to evaluate.
         */
        query: {
          type:String,
          observer: '_queryChanged'
        },
        /**
         * If true, the query attribute is assumed to be a complete media query
         * string rather than a single media feature.
         */
        full: {
          type:Boolean,
          value: false
        },
        /**
         * @type {function(MediaQueryList)}
         */
        _boundMediaQueryHandler: {
          value: function() {
            return this._queryHandler.bind(this);
          }
        },
        /**
         * @type {MediaQueryList}
         */
        _mq: {
          value: null
        }
      }
    }

    connectedCallback() {
      super.connectedCallback();
      this._queryChanged();
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      this._remove();
    }

    _add() {
      if (this._mq) {
        this._mq.addListener(this._boundMediaQueryHandler);
      }
    }

    _remove() {
      if (this._mq) {
        this._mq.removeListener(this._boundMediaQueryHandler);
      }
      this._mq = null;
    }

    _queryChanged() {
      this._remove();
      let query = this.query;
      if(!query) {
        return;
      }
      if(!this.full && query[0] !== '(') {
        query = '(' + query + ')';
      }
      this._mq = window.matchMedia(query);
      this._add();
      this._queryHandler(this._mq);
    }

    _queryHandler(mq) {
      this._setQueryMatches(mq.matches);
    }

  }
  window.customElements.define(HookMediaQuery.is, HookMediaQuery);
</script>
