<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/flattened-nodes-observer.html">
<!--
`<hook-picture>` is a picture element that mimics the HTML5 `<picture>` element.  Use iron-image, img or don't include an image to use a div with a background-image.  Just include what media queries you wish to use and the element will adjust to your needs.

### Example:

    // Using an image
    <hook-picture>
      <hook-picture-source src="http://placehold.it/1000x150" media="(min-width: 1000px)"></hook-picture-source>
      <hook-picture-source src="http://placehold.it/600x150" media="(min-width: 600px)"></hook-picture-source>
      <img src="http://placehold.it/350x150" alt="image" default>
    </hook-picture>

    // Using an iron image
    <hook-picture>
      <hook-picture-source src="http://placehold.it/1000x150" media="(min-width: 1000px)"></hook-picture-source>
      <hook-picture-source src="http://placehold.it/600x150" media="(min-width: 600px)"></hook-picture-source>
      <iron-image src="http://placehold.it/350x150" alt="image" default></iron-image>
    </hook-picture>

    // Using a background image
    <hook-picture src="http://placehold.it/350x150">
      <hook-picture-source src="http://placehold.it/1000x150" media="(min-width: 1000px)"></hook-picture-source>
      <hook-picture-source src="http://placehold.it/600x150" media="(min-width: 600px)"></hook-picture-source>
    </hook-picture>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--hook-picture` | Mixin applied to the element | `{}`

@element hook-picture
@demo demo/index.html
-->

<dom-module id="hook-picture">

  <template>

    <style lang="sass">

      :host {
        display: inherit;
        @apply(--hook-picture);
      }

    </style>

    <slot id="slot"></slot>

  </template>

  <script>
    class HookPicture extends Polymer.Element {
      static get is() {
        return 'hook-picture';
      }

      static get properties() {
        return {
          src: {
            type: String
          },
          _boundQueryMatchHandler: {
            type: Function,
            value: function() {
              return this._queryMatchesChanged.bind(this);
            }
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this._observer = new Polymer.FlattenedNodesObserver(this.$.slot, (info) => {
          this._processNewNodes(info.addedNodes);
          this._processRemovedNodes(info.removedNodes);
        });
        let nodes = Polymer.FlattenedNodesObserver.getFlattenedNodes(this.$.slot);
        this._processNewNodes(nodes);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._observer.disconnect();
      }

      _queryMatchesChanged() {
        console.log('changed!');
      }

      _processNewNodes(nodes) {
        nodes.filter(function(node) {
          return (node.nodeType === Node.ELEMENT_NODE)
        }).forEach(function(node) {
          console.log(node);
          node.addEventListener('query-matches-changed', this._boundQueryMatchHandler);
        }.bind(this));
      }

      _processRemovedNodes(nodes) {
        nodes.filter(function(node) {
          return (node.nodeType === Node.ELEMENT_NODE)
        }).forEach(function(node) {
          node.removeEventListener('query-matches-changed', this._boundQueryMatchHandler);
        }.bind(this));
      }

    }
    window.customElements.define(HookPicture.is, HookPicture);
  </script>

</dom-module>
